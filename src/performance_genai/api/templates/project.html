<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>{{ project.name }}</title>
    <style>
      :root {
        --bg: #0f1a16;
        --panel: rgba(255,255,255,0.06);
        --panel2: rgba(255,255,255,0.10);
        --stroke: rgba(255,255,255,0.12);
        --text: rgba(255,255,255,0.94);
        --muted: rgba(255,255,255,0.70);
        --link: #8fe4c7;
        --danger: #e55c76;
        --shadow: rgba(0,0,0,0.35);
      }
      body { background: radial-gradient(1200px 700px at 15% 0%, rgba(143,228,199,0.14), transparent 60%), var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Arial; margin: 0; }
      a { color: var(--link); text-decoration: none; }
      a:hover { text-decoration: underline; }
      code { background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 8px; border: 1px solid var(--stroke); }
      .wrap { max-width: 1200px; margin: 0 auto; padding: 18px 16px 30px; }
      .topbar { display:flex; justify-content: space-between; align-items: center; gap: 14px; padding: 10px 12px; border: 1px solid var(--stroke); border-radius: 14px; background: var(--panel); box-shadow: 0 12px 30px var(--shadow); }
      .title { display:flex; flex-direction: column; gap: 2px; }
      .title h1 { font-size: 18px; margin: 0; letter-spacing: 0.2px; }
      .title .meta { color: var(--muted); font-size: 12px; }
      .btn { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--stroke); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; }
      .btn:hover { background: rgba(255,255,255,0.10); }
      .btn-danger { background: rgba(229,92,118,0.14); border-color: rgba(229,92,118,0.35); color: var(--text); }
      .btn-danger:hover { background: rgba(229,92,118,0.22); }
      .layout { display:grid; grid-template-columns: 420px 1fr; gap: 14px; margin-top: 14px; }
      @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }
      .panel { border: 1px solid var(--stroke); border-radius: 14px; padding: 12px; background: var(--panel); box-shadow: 0 10px 24px var(--shadow); }
      .panel h2 { font-size: 14px; margin: 0 0 10px; letter-spacing: 0.3px; text-transform: uppercase; color: rgba(255,255,255,0.86); }
      .stack { display:flex; flex-direction: column; gap: 12px; }
      label { display:block; font-size: 12px; color: var(--muted); margin-top: 8px; }
      textarea { width: 100%; min-height: 84px; padding: 10px; border-radius: 12px; border: 1px solid var(--stroke); background: rgba(0,0,0,0.22); color: var(--text); }
      input[type=text], input[type=number], select { width: 100%; padding: 10px; border-radius: 12px; border: 1px solid var(--stroke); background: rgba(0,0,0,0.22); color: var(--text); }
      input[type=file] { width: 100%; color: var(--muted); }
      .muted { color: var(--muted); font-size: 12px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
      .thumb { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 12px; border: 1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.22); }
      .item { border: 1px solid rgba(255,255,255,0.10); border-radius: 14px; padding: 10px; background: rgba(0,0,0,0.20); }
      .item .k { display:flex; justify-content: space-between; gap: 8px; margin-top: 8px; align-items: center; }
      .item .k small { color: var(--muted); }
      .row { display:flex; gap: 10px; }
      .row > div { flex: 1; }
      .pill { display:inline-flex; align-items:center; gap: 6px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--stroke); background: rgba(255,255,255,0.05); font-size: 12px; color: var(--muted); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="topbar">
        <div class="title">
          <div class="muted"><a href="/">&lt;- projects</a></div>
          <h1>{{ project.name }}</h1>
          <div class="meta">Project ID: <code>{{ project.project_id }}</code></div>
        </div>
        <div class="row" style="align-items:center;">
          <span class="pill">refs: {{ (assets | selectattr('kind','equalto','reference') | list | length) }}</span>
          <span class="pill">kvs: {{ kvs|length }}</span>
          <span class="pill">masters: {{ masters|length }}</span>
          <form method="post" action="/projects/{{ project.project_id }}/delete" onsubmit="return confirm('Delete this project and all its assets?');">
            <button class="btn btn-danger" type="submit">Delete project</button>
          </form>
        </div>
      </div>

      <div class="layout">
        <div class="stack">
          <div class="panel">
            <h2>Upload</h2>
            <form method="post" action="/projects/{{ project.project_id }}/assets/upload" enctype="multipart/form-data">
              <label>Kind</label>
              <select name="kind">
                <option value="reference">reference</option>
                <option value="product">product</option>
                <option value="motif">motif (transparent PNG)</option>
              </select>
              <label>File</label>
              <input type="file" name="file" accept="image/*" required />
              <button class="btn" type="submit" style="margin-top:10px;">Upload</button>
            </form>
          </div>

          <div class="panel">
            <h2>Brand Profile (Vision)</h2>
            <div class="muted">Uses uploaded images to propose palette/mood/composition and do/don't language.</div>
            <form method="post" action="/projects/{{ project.project_id }}/profile/propose">
              <label>Brief (optional)</label>
              <textarea name="brief_text" placeholder="Product, objective, tone..."></textarea>
              <button class="btn" type="submit" style="margin-top:10px;">Propose profile</button>
            </form>
            {% if observed_profile %}
              <details style="margin-top:10px;">
                <summary class="muted">View observed_profile</summary>
                <pre style="white-space: pre-wrap; font-size: 12px; color: rgba(255,255,255,0.82);">{{ observed_profile_pretty }}</pre>
              </details>
            {% endif %}
          </div>

          <div class="panel">
            <h2>Generate KVs (Image)</h2>
            <form method="post" action="/projects/{{ project.project_id }}/kvs/generate">
              <label>Prompt</label>
              <textarea name="prompt" required placeholder="e.g., lifestyle scene..."></textarea>
              <label style="display:flex; gap:8px; align-items:center; margin-top:10px;">
                <input type="checkbox" name="use_images" value="true" checked />
                Use uploaded reference/product images as visual refs
              </label>
              <div class="row" style="margin-top:8px;">
                <div>
                  <label>N</label>
                  <input type="number" name="n" value="2" min="1" max="8" />
                </div>
                <div>
                  <label>Aspect ratio</label>
                  <select name="aspect_ratio">
                    <option value="1:1">1:1</option>
                    <option value="4:5">4:5</option>
                    <option value="9:16">9:16</option>
                  </select>
                </div>
              </div>
              <button class="btn" type="submit" style="margin-top:10px;">Generate</button>
            </form>
          </div>

          <div class="panel">
            <h2>AI Reframe KV (Text-Free Visuals)</h2>
            <div class="muted">Uses the image model to generate ratio-specific visuals (keep subject + integrate motif) with no text. Good when deterministic cropping breaks brand motifs.</div>
            <form method="post" action="/projects/{{ project.project_id }}/kvs/reframe">
              <label>Base KV</label>
              <select name="kv_asset_id" required>
                {% for kv in kvs %}
                  <option value="{{ kv.asset_id }}" {% if kv.asset_id == selected_kv %}selected{% endif %}>{{ kv.asset_id }} ({{ kv.filename }})</option>
                {% endfor %}
              </select>
              <label>Motif (optional, transparent PNG)</label>
              <select name="motif_asset_id">
                <option value="">(none)</option>
                {% for m in motifs %}
                  <option value="{{ m.asset_id }}">{{ m.asset_id }} ({{ m.filename }})</option>
                {% endfor %}
              </select>
              <div class="row" style="margin-top:8px;">
                <div>
                  <label>Aspect ratio</label>
                  <select name="aspect_ratio">
                    <option value="1:1">1:1</option>
                    <option value="4:5">4:5</option>
                    <option value="9:16" selected>9:16</option>
                    <option value="16:9">16:9</option>
                    <option value="3:4">3:4</option>
                    <option value="4:3">4:3</option>
                    <option value="21:9">21:9</option>
                  </select>
                </div>
                <div>
                  <label>Image size</label>
                  <select name="image_size">
                    <option value="1K">1K</option>
                    <option value="2K" selected>2K</option>
                    <option value="4K">4K</option>
                  </select>
                </div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div>
                  <label>N</label>
                  <input type="number" name="n" value="1" min="1" max="4" />
                </div>
                <div></div>
              </div>
              <label>Instruction (optional)</label>
              <textarea name="prompt">Return the SAME image, just expanded to the target aspect ratio by outpainting ONLY the new canvas areas. Do NOT change the existing pixels/subject identity. No text, no logos, no watermarks.</textarea>
              <button class="btn" type="submit" style="margin-top:10px;">AI reframe</button>
              {% if not kvs %}
                <p class="muted" style="margin-top:10px;">Generate a KV first.</p>
              {% endif %}
            </form>
          </div>

          <div class="panel">
            <h2>Copy (Headlines)</h2>
            <form method="post" action="/projects/{{ project.project_id }}/copy/headlines">
              <label>Brief</label>
              <textarea name="brief_text" required placeholder="Product details, offer, objective, constraints..."></textarea>
              <label style="display:flex; gap:8px; align-items:center; margin-top:10px;">
                <input type="checkbox" name="use_images" value="true" />
                Use uploaded images as reference
              </label>
              <label>Count</label>
              <input type="number" name="count" value="10" min="3" max="30" />
              <button class="btn" type="submit" style="margin-top:10px;">Generate headlines</button>
            </form>
          </div>

          <div class="panel">
            <h2>Masters (Assembly)</h2>
            <div class="muted">Deterministic overlay of headline + CTA. Use motif once you have it.</div>
            <form method="post" action="/projects/{{ project.project_id }}/masters/build">
              <label>KV</label>
              <select name="kv_asset_id" required>
                {% for kv in kvs %}
                  <option value="{{ kv.asset_id }}" {% if kv.asset_id == selected_kv %}selected{% endif %}>{{ kv.asset_id }} ({{ kv.filename }})</option>
                {% endfor %}
              </select>
              <label>Headline (select or type)</label>
              <select name="headline_select">
                <option value="">(select headline)</option>
                {% for h in headlines %}
                  <option value="{{ h }}" {% if h == selected_headline %}selected{% endif %}>{{ h }}</option>
                {% endfor %}
              </select>
              <input type="text" name="headline" placeholder="Or type a headline" value="{{ selected_headline }}" />
              <label>CTA</label>
              <input type="text" name="cta" value="Learn more" />
              <label>Motif (optional)</label>
              <select name="motif_asset_id">
                <option value="">(none)</option>
                {% for m in motifs %}
                  <option value="{{ m.asset_id }}">{{ m.asset_id }} ({{ m.filename }})</option>
                {% endfor %}
              </select>
              <div class="row" style="margin-top:8px;">
                <div>
                  <label>Motif position</label>
                  <select name="motif_position">
                    <option value="right">right</option>
                    <option value="left">left</option>
                    <option value="center">center</option>
                    <option value="full">full (cover)</option>
                  </select>
                </div>
                <div>
                  <label>Subject position (protect)</label>
                  <select name="subject_position">
                    <option value="right">right</option>
                    <option value="left">left</option>
                    <option value="center">center</option>
                    <option value="none">none</option>
                  </select>
                </div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div>
                  <label>Motif opacity</label>
                  <input type="number" name="motif_opacity" value="0.14" min="0" max="1" step="0.01" />
                </div>
                <div>
                  <label>Motif tint hex</label>
                  <input type="text" name="motif_tint_hex" value="#266156" />
                  <div class="muted">Set empty to keep motif's original color.</div>
                </div>
              </div>
              <button class="btn" type="submit" style="margin-top:10px;">Build 3 ratios</button>
              {% if not kvs %}
                <p class="muted" style="margin-top:10px;">Generate a KV first.</p>
              {% endif %}
            </form>
          </div>
        </div>

        <div class="stack">
          <div class="panel">
            <h2>Uploaded</h2>
            <div class="muted">Reference/product images and motif assets for this project.</div>
            <div class="grid" style="margin-top:10px;">
              {% for a in assets %}
                {% if a.kind in ['reference','product','motif'] %}
                  <div class="item">
                    <img class="thumb" src="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" />
                    <div class="k">
                      <small>{{ a.kind }}</small>
                      <small><code>{{ a.asset_id }}</code></small>
                    </div>
                    <div class="k">
                      <a class="muted" href="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" target="_blank">open</a>
                      <form method="post" action="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}/delete" onsubmit="return confirm('Delete this asset?');">
                        <button class="btn" type="submit">Delete</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <div class="panel">
            <h2>KVs</h2>
            {% if kvs %}
              <div class="k" style="margin-bottom:10px;">
                <small class="muted">Bulk actions</small>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="btn" type="button" onclick="toggleAll('kv', true)">Select all</button>
                  <button class="btn" type="button" onclick="toggleAll('kv', false)">Clear</button>
                  <form id="bulk_kv_delete" method="post" action="/projects/{{ project.project_id }}/assets/bulk_delete" onsubmit="return confirm('Delete selected KVs?');">
                    <button class="btn btn-danger" type="submit">Delete selected</button>
                  </form>
                </div>
              </div>
              <div class="grid">
                {% for a in kvs %}
                  <div class="item">
                    <img class="thumb" src="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" />
                    <div class="k">
                      <small>
                        <input data-bulk="kv" type="checkbox" name="asset_ids" value="{{ a.asset_id }}" form="bulk_kv_delete" />
                        kv
                      </small>
                      <small><code>{{ a.asset_id }}</code></small>
                    </div>
                    <div class="k">
                      <a class="muted" href="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" target="_blank">open</a>
                      <a class="muted" href="/projects/{{ project.project_id }}?kv={{ a.asset_id }}">use for masters</a>
                      <form method="post" action="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}/delete" onsubmit="return confirm('Delete this KV?');">
                        <button class="btn" type="submit">Delete</button>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted">No KVs yet.</p>
            {% endif %}
          </div>

          <div class="panel">
            <h2>Masters</h2>
            {% if masters %}
              <div class="k" style="margin-bottom:10px;">
                <small class="muted">Bulk actions</small>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="btn" type="button" onclick="toggleAll('master', true)">Select all</button>
                  <button class="btn" type="button" onclick="toggleAll('master', false)">Clear</button>
                  <form id="bulk_master_delete" method="post" action="/projects/{{ project.project_id }}/assets/bulk_delete" onsubmit="return confirm('Delete selected masters?');">
                    <button class="btn btn-danger" type="submit">Delete selected</button>
                  </form>
                </div>
              </div>
              <div class="grid">
                {% for a in masters %}
                  <div class="item">
                    <img class="thumb" src="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" />
                    <div class="k">
                      <small>
                        <input data-bulk="master" type="checkbox" name="asset_ids" value="{{ a.asset_id }}" form="bulk_master_delete" />
                        {{ a.metadata.ratio }}
                      </small>
                      <small><code>{{ a.asset_id }}</code></small>
                    </div>
                    <div class="k">
                      <a class="muted" href="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" target="_blank">open</a>
                      <form method="post" action="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}/delete" onsubmit="return confirm('Delete this master?');">
                        <button class="btn" type="submit">Delete</button>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted">No masters yet.</p>
            {% endif %}
          </div>

          <div class="panel">
            <h2>Headlines</h2>
            {% if headlines %}
              <div class="item">
                <ol style="margin: 0; padding-left: 18px;">
                  {% for h in headlines %}
                    <li style="margin-bottom: 6px;">
                      {{ h }}
                      <a class="muted" href="/projects/{{ project.project_id }}?headline={{ h|urlencode }}">use</a>
                    </li>
                  {% endfor %}
                </ol>
              </div>
            {% else %}
              <p class="muted">No headlines yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <script>
      function toggleAll(kind, checked) {
        var nodes = document.querySelectorAll('input[data-bulk=\"' + kind + '\"]');
        for (var i = 0; i < nodes.length; i++) nodes[i].checked = checked;
      }
    </script>
  </body>
</html>
