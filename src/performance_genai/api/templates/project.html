<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>{{ project.name }}</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@500;600&display=swap');
      :root {
        --bg: #0b0c10;
        --bg2: #141920;
        --panel: rgba(18, 21, 26, 0.85);
        --panel2: rgba(24, 28, 34, 0.9);
        --stroke: rgba(255,255,255,0.10);
        --text: #f5f3ee;
        --muted: rgba(245,243,238,0.68);
        --link: #ffffff;
        --danger: #b64555;
        --shadow: rgba(0,0,0,0.45);
        --accent: #f2f0ea;
        --accent-text: #0b0c10;
      }
      * { box-sizing: border-box; }
      body {
        background: radial-gradient(1200px 700px at 15% 0%, rgba(255,255,255,0.10), transparent 60%), linear-gradient(145deg, var(--bg), var(--bg2));
        color: var(--text);
        font-family: "Manrope", ui-sans-serif, system-ui;
        margin: 0;
      }
      a { color: var(--link); text-decoration: none; }
      a:hover { text-decoration: underline; }
      code { background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 8px; border: 1px solid var(--stroke); }
      .wrap { max-width: 100%; margin: 0 auto; padding: 24px 28px 36px; }
      .topbar { display:flex; justify-content: space-between; align-items: center; gap: 14px; padding: 16px 18px; border: 1px solid var(--stroke); border-radius: 18px; background: var(--panel); box-shadow: 0 16px 36px var(--shadow); }
      .brand-mark { display:flex; align-items:center; gap: 12px; }
      .brand-logo { height: 28px; width: auto; display:block; filter: drop-shadow(0 10px 18px rgba(0,0,0,0.35)); }
      .title { display:flex; flex-direction: column; gap: 2px; }
      .title h1 { font-size: 22px; margin: 0; letter-spacing: 0.3px; font-family: "Space Grotesk", "Manrope", sans-serif; }
      .title .meta { color: var(--muted); font-size: 12px; }
      .btn { padding: 9px 14px; border-radius: 12px; border: 1px solid var(--stroke); background: rgba(255,255,255,0.08); color: var(--text); cursor: pointer; font-family: "Manrope", ui-sans-serif, system-ui; }
      .btn:hover { background: rgba(255,255,255,0.14); }
      .btn-primary { background: var(--accent); color: var(--accent-text); border-color: rgba(255,255,255,0.4); }
      .btn-primary:hover { filter: brightness(0.96); }
      .btn-danger { background: rgba(182,69,85,0.22); border-color: rgba(182,69,85,0.5); color: var(--text); }
      .btn-danger:hover { background: rgba(182,69,85,0.30); }
      .layout { display:grid; grid-template-columns: minmax(320px, 420px) minmax(0, 1fr); gap: 18px; margin-top: 18px; }
      @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }
      .panel { border: 1px solid var(--stroke); border-radius: 16px; padding: 16px; background: var(--panel2); box-shadow: 0 12px 26px var(--shadow); }
      .panel h2 { font-size: 14px; margin: 0 0 10px; letter-spacing: 0.3px; text-transform: uppercase; color: rgba(255,255,255,0.86); }
      .stack { display:flex; flex-direction: column; gap: 14px; min-width: 0; }
      form { max-width: 100%; }
      label { display:block; font-size: 12px; color: var(--muted); margin-top: 8px; }
      textarea { width: 100%; min-height: 84px; max-width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--stroke); background: rgba(0,0,0,0.35); color: var(--text); resize: vertical; }
      input[type=text], input[type=number], select { width: 100%; max-width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--stroke); background: rgba(0,0,0,0.35); color: var(--text); min-width: 0; }
      input[type=file] { width: 100%; max-width: 100%; color: var(--muted); }
      .muted { color: var(--muted); font-size: 12px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
      .thumb { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 12px; border: 1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.22); }
      .item { border: 1px solid rgba(255,255,255,0.10); border-radius: 14px; padding: 10px; background: rgba(0,0,0,0.20); }
      .item .k { display:flex; justify-content: space-between; gap: 8px; margin-top: 8px; align-items: center; }
      .item .k small { color: var(--muted); }
      .row { display:flex; gap: 10px; flex-wrap: wrap; }
      .row > div { flex: 1; min-width: 0; }
      .pill { display:inline-flex; align-items:center; gap: 6px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--stroke); background: rgba(255,255,255,0.05); font-size: 12px; color: var(--muted); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="topbar">
        <div class="brand-mark">
          <img class="brand-logo" src="/assets/avigya-horizontal.png" alt="Avigya" />
          <div class="title">
            <div class="muted"><a href="/">&lt;- ad sets</a></div>
            <h1>{{ project.name }}</h1>
            <div class="meta">
              {% if project.brand_name %}Brand: <code>{{ project.brand_name }}</code>{% endif %}
              {% if project.campaign_name %} Campaign: <code>{{ project.campaign_name }}</code>{% endif %}
              &nbsp; Ad set ID: <code>{{ project.project_id }}</code>
            </div>
          </div>
        </div>
        <div class="row" style="align-items:center;">
          <span class="pill">refs: {{ (assets | selectattr('kind','equalto','reference') | list | length) }}</span>
          <span class="pill">visuals: {{ base_kvs|length }}</span>
          <span class="pill">shortlisted: {{ shortlisted_kvs|length }}</span>
          <a class="btn btn-primary" href="/projects/{{ project.project_id }}/editor">Open editor</a>
          <form method="post" action="/projects/{{ project.project_id }}/delete" onsubmit="return confirm('Delete this project and all its assets?');">
            <button class="btn btn-danger" type="submit">Delete ad set</button>
          </form>
        </div>
      </div>

      <div class="layout">
        <div class="stack">
          <div class="panel">
            <h2>Upload</h2>
            <form method="post" action="/projects/{{ project.project_id }}/assets/upload" enctype="multipart/form-data">
              <label>Kind</label>
              <select name="kind">
                <option value="reference">reference</option>
                <option value="product">product</option>
                <option value="motif">motif (transparent PNG)</option>
                <option value="element">element</option>
              </select>
              <label>File</label>
              <input type="file" name="file" accept="image/*" required />
              <button class="btn btn-primary" type="submit" style="margin-top:10px;">Upload</button>
            </form>
          </div>

          <div class="panel">
            <h2>Brand Profile (Advanced)</h2>
            <details>
              <summary class="muted">Propose observed profile from uploaded images</summary>
              <div class="muted" style="margin-top:6px;">Uses uploaded images to propose palette/mood/composition and do/don't language.</div>
              <form method="post" action="/projects/{{ project.project_id }}/profile/propose">
                <label>Brief (optional)</label>
                <textarea name="brief_text" placeholder="Product, objective, tone..."></textarea>
                <button class="btn btn-primary" type="submit" style="margin-top:10px;">Propose profile</button>
              </form>
              {% if observed_profile %}
                <details style="margin-top:10px;">
                  <summary class="muted">View observed_profile</summary>
                  <pre style="white-space: pre-wrap; font-size: 12px; color: rgba(255,255,255,0.82);">{{ observed_profile_pretty }}</pre>
                </details>
              {% endif %}
            </details>
          </div>

          <div class="panel">
            <h2>Generate Visual Pool</h2>
            <div class="muted">Create a small set of base visuals (max 5) to shortlist.</div>
            <form method="post" action="/projects/{{ project.project_id }}/kvs/generate">
              <label>Prompt</label>
              <textarea name="prompt" required placeholder="e.g., lifestyle scene..."></textarea>
              <input type="hidden" name="aspect_ratio" value="1:1" />
              <label style="display:flex; gap:8px; align-items:center; margin-top:10px;">
                <input type="checkbox" name="use_images" value="true" checked />
                Use uploaded reference/product images as visual refs
              </label>
              <div class="row" style="margin-top:8px;">
                <div>
                  <label>N</label>
                  <input type="number" name="n" value="3" min="1" max="5" />
                </div>
                <div></div>
              </div>
              <button class="btn btn-primary" type="submit" style="margin-top:10px;">Generate</button>
            </form>
          </div>

          <div class="panel">
            <h2>Headlines</h2>
            <details>
              <summary class="muted">Generated headlines ({{ headlines|length }})</summary>
              {% if headlines %}
                <div class="stack" style="margin-top:10px;">
                  <form method="post" action="/projects/{{ project.project_id }}/copy/headlines/delete" onsubmit="return confirm('Clear all headlines?');">
                    <input type="hidden" name="clear_all" value="1" />
                    <input type="hidden" name="return_to" value="/projects/{{ project.project_id }}" />
                    <button class="btn btn-danger" type="submit">Clear all</button>
                  </form>
                  {% for h in headlines %}
                    <div class="item">
                      <div class="muted" style="font-size:12px;">{{ h }}</div>
                      <form method="post" action="/projects/{{ project.project_id }}/copy/headlines/delete" onsubmit="return confirm('Delete this headline?');" style="margin-top:8px;">
                        <input type="hidden" name="indices" value="{{ loop.index0 }}" />
                        <input type="hidden" name="return_to" value="/projects/{{ project.project_id }}" />
                        <button class="btn btn-danger" type="submit">Delete</button>
                      </form>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="muted" style="margin-top:10px;">No headlines generated yet.</div>
              {% endif %}
            </details>
          </div>
        </div>

        <div class="stack">
          <div class="panel">
            <h2>Uploaded</h2>
            <div class="muted">Reference/product images and motif assets for this project.</div>
            <div class="grid" style="margin-top:10px;">
              {% for a in assets %}
                {% if a.kind in ['reference','product','motif'] %}
                  <div class="item">
                    <img class="thumb" src="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" />
                    <div class="k">
                      <small>{{ a.kind }}</small>
                      <small><code>{{ a.asset_id }}</code></small>
                    </div>
                    <div class="k">
                      <a class="muted" href="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" target="_blank">open</a>
                      <form method="post" action="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}/delete" onsubmit="return confirm('Delete this asset?');">
                        <button class="btn btn-danger" type="submit">Delete</button>
                      </form>
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <div class="panel">
            <h2>Visual Pool</h2>
            {% if base_kvs %}
              <div class="k" style="margin-bottom:10px;">
                <small class="muted">Bulk actions</small>
                <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                  <button class="btn" type="button" onclick="toggleAll('kv', true)">Select all</button>
                  <button class="btn" type="button" onclick="toggleAll('kv', false)">Clear</button>
                  <form id="bulk_kv_delete" method="post" action="/projects/{{ project.project_id }}/assets/bulk_delete" onsubmit="return confirm('Delete selected KVs?');">
                    <input type="hidden" name="asset_kind" value="kv" />
                    <button class="btn btn-danger" type="submit">Delete selected</button>
                  </form>
                </div>
              </div>
              <div class="grid">
                {% for a in base_kvs %}
                  <div class="item">
                    <img class="thumb" src="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" />
                    <div class="k">
                      <small>
                        <input data-bulk="kv" type="checkbox" name="asset_ids" value="{{ a.asset_id }}" form="bulk_kv_delete" />
                        kv
                      </small>
                      <small><code>{{ a.asset_id }}</code></small>
                    </div>
                    <div class="k">
                      <small class="muted">{{ a.metadata.get('display_name', a.filename) }}</small>
                    </div>
                    <div class="k">
                      <a class="muted" href="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" target="_blank">open</a>
                      {% if a.metadata.get('shortlisted') %}
                        <small class="pill">shortlisted</small>
                      {% endif %}
                      <form method="post" action="/projects/{{ project.project_id }}/kvs/{{ a.asset_id }}/shortlist">
                        <input type="hidden" name="shortlisted" value="{% if a.metadata.get('shortlisted') %}0{% else %}1{% endif %}" />
                        <button class="btn {% if not a.metadata.get('shortlisted') %}btn-primary{% endif %}" type="submit">{% if a.metadata.get('shortlisted') %}Remove{% else %}Shortlist{% endif %}</button>
                      </form>
                      <form method="post" action="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}/delete" onsubmit="return confirm('Delete this KV?');">
                        <button class="btn btn-danger" type="submit">Delete</button>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted">No visuals yet.</p>
            {% endif %}
          </div>

          <div class="panel">
            <h2>Shortlisted</h2>
            {% if shortlisted_kvs %}
              <div class="grid">
                {% for a in shortlisted_kvs %}
                  <div class="item">
                    <img class="thumb" src="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" />
                    <div class="k">
                      <small>kv</small>
                      <small><code>{{ a.asset_id }}</code></small>
                    </div>
                    <div class="k">
                      <small class="muted">{{ a.metadata.get('display_name', a.filename) }}</small>
                    </div>
                    <div class="k">
                      <a class="muted" href="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" target="_blank">open</a>
                      <form method="post" action="/projects/{{ project.project_id }}/kvs/{{ a.asset_id }}/shortlist">
                        <input type="hidden" name="shortlisted" value="0" />
                        <button class="btn" type="submit">Remove</button>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted">No shortlisted visuals yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <script>
      function toggleAll(kind, checked) {
        var nodes = document.querySelectorAll('input[data-bulk=\"' + kind + '\"]');
        for (var i = 0; i < nodes.length; i++) nodes[i].checked = checked;
      }
    </script>
  </body>
</html>
