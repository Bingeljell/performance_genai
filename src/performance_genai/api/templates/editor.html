<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>{{ project.name }} â€” Editor</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@500;600&display=swap');
      :root {
        --bg: #0b0c10;
        --bg2: #141920;
        --panel: rgba(18, 21, 26, 0.86);
        --panel2: rgba(24, 28, 34, 0.92);
        --stroke: rgba(255,255,255,0.12);
        --text: #f5f3ee;
        --muted: rgba(245,243,238,0.70);
        --link: #f7f5f0;
        --shadow: rgba(0,0,0,0.40);
        --accent: #f2f0ea;
        --accent-text: #0b0c10;
      }
      body {
        background: radial-gradient(1200px 700px at 15% 0%, rgba(255,255,255,0.10), transparent 60%), linear-gradient(145deg, var(--bg), var(--bg2));
        color: var(--text);
        font-family: "Manrope", ui-sans-serif, system-ui;
        margin: 0;
      }
      a { color: var(--link); text-decoration: none; }
      a:hover { text-decoration: underline; }
      .wrap { max-width: 100%; width: 100%; margin: 0 auto; padding: 20px 24px 34px; }
      .topbar { display:flex; justify-content: space-between; align-items: center; gap: 14px; padding: 12px 14px; border: 1px solid var(--stroke); border-radius: 16px; background: var(--panel); box-shadow: 0 12px 30px var(--shadow); }
      .brand-mark { display:flex; align-items:center; gap: 12px; }
      .brand-logo { height: 26px; width: auto; display:block; filter: drop-shadow(0 10px 18px rgba(0,0,0,0.35)); }
      .title { display:flex; flex-direction: column; gap: 2px; }
      .title h1 { font-size: 20px; margin: 0; letter-spacing: 0.2px; font-family: "Space Grotesk", "Manrope", sans-serif; }
      .title .meta { color: var(--muted); font-size: 12px; }
      .btn { padding: 8px 12px; border-radius: 12px; border: 1px solid var(--stroke); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; font-family: "Manrope", ui-sans-serif, system-ui; }
      .btn:hover { background: rgba(255,255,255,0.12); }
      .btn-primary { background: var(--accent); color: var(--accent-text); border-color: rgba(255,255,255,0.45); }
      .btn-primary:hover { filter: brightness(0.96); }
      .btn-danger { background: rgba(182,69,85,0.22); border-color: rgba(182,69,85,0.5); color: var(--text); }
      .btn-danger:hover { background: rgba(182,69,85,0.30); }
      .btn-icon { width: 34px; height: 34px; padding: 0; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; }
      .layout { display:grid; grid-template-columns: 360px 1fr; gap: 14px; margin-top: 14px; }
      @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }
      .panel { border: 1px solid var(--stroke); border-radius: 14px; padding: 14px; background: var(--panel2); box-shadow: 0 10px 24px var(--shadow); }
      form { max-width: 100%; }
      .panel h2 { font-size: 14px; margin: 0 0 10px; letter-spacing: 0.3px; text-transform: uppercase; color: rgba(255,255,255,0.86); }
      label { display:block; font-size: 12px; color: var(--muted); margin-top: 8px; }
      textarea { width: 100%; min-height: 70px; padding: 10px; border-radius: 12px; border: 1px solid var(--stroke); background: rgba(0,0,0,0.28); color: var(--text); resize: vertical; }
      input[type=text], select { width: 100%; padding: 10px; border-radius: 12px; border: 1px solid var(--stroke); background: rgba(0,0,0,0.28); color: var(--text); }
      .muted { color: var(--muted); font-size: 12px; }
      .canvas-wrap { border: 1px solid var(--stroke); border-radius: 14px; padding: 12px; background: rgba(0,0,0,0.24); }
      .canvas-toolbar { display:flex; gap: 8px; align-items:center; margin-bottom: 10px; flex-wrap: wrap; }
      .field-row { display:flex; gap: 8px; align-items: center; }
      .asset-menu { position: relative; }
      .asset-menu-content { display: none; position: absolute; top: 44px; left: 0; width: 360px; z-index: 60; background: rgba(16, 19, 26, 0.98); }
      .asset-menu[open] .asset-menu-content { display: block; }
      .asset-menu-content .grid { max-height: 320px; overflow: auto; }
      .layer-list { display:flex; flex-direction: column; gap: 6px; margin-top: 10px; }
      .layer-row { display:flex; align-items:center; justify-content: space-between; gap: 8px; padding: 6px 8px; border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; background: rgba(0,0,0,0.18); cursor: pointer; }
      .layer-row:hover { background: rgba(255,255,255,0.06); }
      .layer-row.active { border-color: rgba(255,255,255,0.45); background: rgba(255,255,255,0.08); }
      .layer-row .label { font-size: 12px; color: var(--muted); }
      .layer-controls { display:flex; gap: 6px; }
      canvas { border-radius: 10px; background: transparent; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; margin-top: 10px; }
      .thumb { width: 100%; height: auto; object-fit: contain; border-radius: 12px; border: 1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.22); }
      .item { border: 1px solid rgba(255,255,255,0.10); border-radius: 14px; padding: 10px; background: rgba(0,0,0,0.20); }
      .k { display:flex; justify-content: space-between; gap: 8px; margin-top: 8px; align-items: center; }
      summary { list-style: none; }
      summary::-webkit-details-marker { display: none; }
    </style>
  </head>
  <body data-project-id="{{ project.project_id }}">
    <div class="wrap">
      <div class="topbar">
        <div class="brand-mark">
          <img class="brand-logo" src="/assets/avigya-horizontal.png" alt="Avigya" />
          <div class="title">
            <div class="muted"><a href="/projects/{{ project.project_id }}">&lt;- back to project</a></div>
            <h1>{{ project.name }} â€” Editor</h1>
            <div class="meta">
              {% if project.brand_name %}Brand: <code>{{ project.brand_name }}</code>{% endif %}
              {% if project.campaign_name %} Campaign: <code>{{ project.campaign_name }}</code>{% endif %}
              &nbsp; Ad set ID: <code>{{ project.project_id }}</code>
            </div>
          </div>
        </div>
        <div class="muted">Text placement (Fabric)</div>
      </div>

      <div class="layout">
        <div class="panel">
          <h2>Text Controls</h2>
          <label>Base visual</label>
          <select id="kv-select">
            {% for kv in kv_choices %}
              <option value="{{ kv.id }}" {% if kv.id == selected_kv %}selected{% endif %}>{{ kv.label }}</option>
            {% endfor %}
          </select>
          {% if not kv_choices %}
            <p class="muted" style="margin-top:10px;">No visuals yet. Generate a visual pool first.</p>
          {% endif %}

          <label>Guide ratio</label>
          <select id="guide-select">
            <option value="1:1">1:1 (square)</option>
            <option value="4:5">4:5 (portrait)</option>
            <option value="9:16">9:16 (story)</option>
          </select>
          <div class="muted" style="margin-top:6px;">Dashed frame shows the publishable area. Anything outside is outpaint zone.</div>

          <div class="field-row" style="margin-top:8px;">
            <button class="btn btn-icon" id="btn-insert-text" type="button" title="Insert text box">T</button>
            <details id="asset-menu" class="asset-menu">
              <summary class="btn btn-icon" title="Insert asset">A</summary>
              <div class="panel asset-menu-content">
                <div class="muted">Insert asset from this ad set.</div>
                {% if insert_assets %}
                  <div class="grid" style="margin-top:10px;">
                    {% for a in insert_assets %}
                      <div class="item">
                        <img class="thumb" src="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" />
                        <div class="k">
                          <small class="muted">{{ a.kind }}</small>
                          <button
                            class="btn"
                            type="button"
                            data-insert-asset="{{ a.asset_id }}"
                            data-asset-url="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}"
                          >
                            Insert
                          </button>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="muted" style="margin-top:10px;">No insertable assets yet.</div>
                {% endif %}
                <div style="margin-top:12px;">
                  <div class="muted">Upload new asset</div>
                  <form method="post" action="/projects/{{ project.project_id }}/assets/upload" enctype="multipart/form-data">
                    <label>Kind</label>
                    <select name="kind">
                      <option value="product">product</option>
                      <option value="reference">reference</option>
                      <option value="motif">motif</option>
                      <option value="element">element</option>
                    </select>
                    <input type="file" id="asset-upload-file" name="file" accept="image/*" required style="display:none;" />
                    <div class="field-row" style="margin-top:8px;">
                      <button class="btn" id="btn-upload-asset" type="button">Upload new asset</button>
                      <span class="muted" id="asset-upload-name">No file selected</span>
                    </div>
                    <input type="hidden" name="return_to" value="/projects/{{ project.project_id }}/editor" />
                    <button class="btn btn-primary" type="submit" style="margin-top:8px;">Upload</button>
                  </form>
                </div>
              </div>
            </details>
            <button class="btn btn-icon" id="btn-undo" type="button" title="Undo (last action)">â†©</button>
          </div>

          <label>Font</label>
          <select id="font-select">
            <option value="dejavu">DejaVu Sans</option>
            <option value="helvetica">Helvetica</option>
            <option value="arial">Arial</option>
          </select>

          <label>Text color</label>
          <details id="color-dropdown">
            <summary class="btn" style="display:flex; align-items:center; gap:8px;">
              <span id="color-swatch" style="width:18px; height:18px; border-radius:4px; border:1px solid rgba(255,255,255,0.2); display:inline-block;"></span>
              <span class="muted">Pick color</span>
            </summary>
            <div class="panel" style="margin-top:8px;">
              <div class="field-row">
                <input type="color" id="color-picker" value="#ffffff" />
                <input type="text" id="color-input" value="#ffffff" placeholder="#ffffff" />
              </div>
            </div>
          </details>

          <label>Font size (selected)</label>
          <div class="field-row">
            <select id="font-size-select">
              <option value="">custom</option>
              <option value="10">10</option>
              <option value="12">12</option>
              <option value="14">14</option>
              <option value="16">16</option>
              <option value="18">18</option>
              <option value="20">20</option>
              <option value="24">24</option>
              <option value="28">28</option>
              <option value="32">32</option>
              <option value="36">36</option>
              <option value="40">40</option>
              <option value="48" selected>48</option>
              <option value="56">56</option>
              <option value="64">64</option>
              <option value="72">72</option>
              <option value="96">96</option>
              <option value="120">120</option>
            </select>
            <input type="text" id="font-size-custom" placeholder="custom" />
          </div>

          <label>Align</label>
          <select id="align-select">
            <option value="left">left</option>
            <option value="center">center</option>
          </select>

          <div class="field-row" style="margin-top:10px; flex-wrap:wrap;">
            <button class="btn btn-icon" id="btn-delete-text" type="button" title="Delete selected">ðŸ—‘</button>
            <button class="btn btn-icon" id="btn-duplicate-text" type="button" title="Duplicate selected">â§‰</button>
            <button class="btn btn-icon" id="btn-bring-forward" type="button" title="Bring forward">â†‘</button>
            <button class="btn btn-icon" id="btn-send-back" type="button" title="Send back">â†“</button>
          </div>

          <div class="muted" style="margin-top:10px;">Drag and resize text boxes on the canvas. Use handles to scale.</div>
          <div class="muted" style="margin-top:6px;">Arrow keys nudge selected text (Shift = 10px).</div>

          <label>Layers</label>
          <div id="layer-panel" class="layer-list"></div>
          <button class="btn btn-primary" id="btn-preview" type="button" style="margin-top:10px;">Generate previews (1:1, 4:5, 9:16)</button>

          <div style="margin-top:16px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.10);">
            <div style="font-size: 14px; letter-spacing: 0.3px; text-transform: uppercase; color: rgba(255,255,255,0.86);">Copy Sets</div>
            <div class="muted" style="margin-top:6px;">Generate headline + subhead + CTA sets and apply them to the canvas.</div>
            <form method="post" action="/projects/{{ project.project_id }}/copy/sets">
              <label>Brief</label>
              <textarea name="brief_text" required placeholder="Product, offer, objective, constraints..."></textarea>
              <label style="display:flex; gap:8px; align-items:center; margin-top:10px;">
                <input type="checkbox" name="use_images" value="true" />
                Use uploaded images as reference
              </label>
              <label>Count</label>
              <input type="text" name="count" value="8" />
              <input type="hidden" name="return_to" value="/projects/{{ project.project_id }}/editor" />
              <button class="btn btn-primary" type="submit" style="margin-top:10px;">Generate copy sets</button>
            </form>

            {% if copy_sets %}
              <div style="margin-top:10px;">
                <form method="post" action="/projects/{{ project.project_id }}/copy/sets/delete" onsubmit="return confirm('Clear all copy sets?');">
                  <input type="hidden" name="clear_all" value="1" />
                  <input type="hidden" name="return_to" value="/projects/{{ project.project_id }}/editor" />
                  <button class="btn btn-danger" type="submit">Clear all copy sets</button>
                </form>
              </div>
              <div class="grid">
                {% for s in copy_sets %}
                  <div class="item">
                    <div class="muted" style="font-size:11px;">headline</div>
                    <div style="margin-top:4px;">{{ s.headline }}</div>
                    <div class="muted" style="font-size:11px; margin-top:8px;">subhead</div>
                    <div style="margin-top:4px;">{{ s.subhead }}</div>
                    <div class="muted" style="font-size:11px; margin-top:8px;">cta</div>
                    <div style="margin-top:4px;">{{ s.cta }}</div>
                    <div class="k">
                      <button
                        class="btn use-copy-set"
                        type="button"
                        data-headline="{{ s.headline|e }}"
                        data-subhead="{{ s.subhead|e }}"
                        data-cta="{{ s.cta|e }}"
                      >
                        Insert set
                      </button>
                      <button
                        class="btn btn-danger"
                        type="submit"
                        form="copy-set-delete-{{ loop.index0 }}"
                        onclick="return confirm('Delete this copy set?');"
                      >
                        Delete
                      </button>
                    </div>
                    <form id="copy-set-delete-{{ loop.index0 }}" method="post" action="/projects/{{ project.project_id }}/copy/sets/delete" style="display:none;">
                      <input type="hidden" name="indices" value="{{ loop.index0 }}" />
                      <input type="hidden" name="return_to" value="/projects/{{ project.project_id }}/editor" />
                    </form>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="muted" style="margin-top:10px;">No copy sets yet.</div>
            {% endif %}
          </div>

          <form id="preview-form" method="post" action="/projects/{{ project.project_id }}/layouts/preview">
            <input type="hidden" name="kv_asset_id" id="form-kv" />
            <input type="hidden" name="text_layers" id="form-text-layers" />
            <input type="hidden" name="elements" id="form-elements" />
            <input type="hidden" name="image_box" id="form-image-box" />
            <input type="hidden" name="guide_ratio" id="form-guide-ratio" />
            <input type="hidden" name="font_family" id="form-font" />
            <input type="hidden" name="text_color" id="form-color" />
            <input type="hidden" name="text_align" id="form-align" />
            <input type="hidden" name="font_scale" id="form-font-scale" />
            <input type="hidden" name="return_to" value="/projects/{{ project.project_id }}/editor" />
          </form>
        </div>

          <div class="panel">
            <h2>Canvas</h2>
            <div class="canvas-wrap">
              <div class="canvas-toolbar">
                <span class="muted" id="kv-label">No visual selected</span>
              </div>
              <div id="canvas-stage" style="position: relative; display: inline-block;">
                <img id="kv-bg" alt="kv background" style="display:block; max-width: 900px; border-radius: 10px;" />
                <canvas id="editor-canvas" width="900" height="900"></canvas>
              </div>
            </div>
            <details style="margin-top:10px;">
              <summary class="muted">Debug</summary>
              <pre id="debug-log" style="white-space: pre-wrap; font-size: 12px; color: rgba(255,255,255,0.82);"></pre>
            </details>

            {% if text_previews %}
              <div style="margin-top:14px;">
                <div class="k" style="margin-bottom:8px;">
                  <div class="muted">Recent text previews</div>
                  <label class="muted" style="display:flex; align-items:center; gap:6px;">
                    <input type="checkbox" id="preview-select-all" />
                    Select all
                  </label>
                </div>
                <form method="post" action="/projects/{{ project.project_id }}/assets/bulk_delete">
                  <input type="hidden" name="return_to" value="/projects/{{ project.project_id }}/editor" />
                  <input type="hidden" name="asset_kind" value="text_preview" />
                  <div class="grid">
                    {% for a in text_previews[:9] %}
                      <div class="item">
                        <img class="thumb" src="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" />
                      <div class="k">
                        <small class="muted">{{ a.metadata.ratio }}</small>
                        <div style="display:flex; gap:8px; align-items:center;">
                          <a class="muted" href="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}" target="_blank">open</a>
                          {% if a.metadata.ratio_layout_id %}
                            <a class="muted" href="/projects/{{ project.project_id }}/editor?layout_id={{ a.metadata.ratio_layout_id }}">open in editor</a>
                          {% endif %}
                        </div>
                      </div>
                      {% if a.metadata.debug_text_layers %}
                        <details style="margin-top:6px;">
                          <summary class="muted">debug</summary>
                          <pre style="white-space: pre-wrap; font-size: 11px; color: rgba(255,255,255,0.78);">{{ a.metadata.debug_text_layers | tojson }}</pre>
                        </details>
                      {% endif %}
                        <div class="k">
                          <label class="muted" style="display:flex; align-items:center; gap:6px;">
                            <input type="checkbox" class="preview-select" name="asset_ids" value="{{ a.asset_id }}" />
                            select
                          </label>
                          <button
                            class="btn btn-danger"
                            type="submit"
                            formaction="/projects/{{ project.project_id }}/assets/{{ a.asset_id }}/delete"
                            formmethod="post"
                            onclick="return confirm('Delete this preview?');"
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                  <div class="k" style="margin-top:10px;">
                    <button class="btn btn-danger" type="submit" onclick="return confirm('Delete selected previews?');">Delete selected</button>
                  </div>
                </form>
              </div>
            {% endif %}
          </div>
      </div>
    </div>

    <script id="kv-data" type="application/json">{{ kv_choices_json | safe }}</script>
    {% if editor_layout %}
      <script id="layout-data" type="application/json">{{ editor_layout | tojson }}</script>
    {% endif %}
    <script src="/static/editor.js?v=23"></script>
  </body>
</html>
